name: Auto Generate wallpapers.json

on:
  push:
    branches: [ main ]
    paths:
      - "*.jpg"
      - "*.jpeg"
      - "*.png"
      - "*.webp"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate wallpapers.json
        run: |
          echo "[" > wallpapers.json
          first=true
          for img in *.jpg *.jpeg *.png *.webp; do
            [ -f "$img" ] || continue

            # Convert filename -> Title
            TITLE=$(echo "$img" | sed 's/\.[^.]*$//' | sed 's/[-_]/ /g' | awk '{for(i=1;i<=NF;i++)$i=toupper(substr($i,1,1)) substr($i,2)}1')
            RAW="https://raw.githubusercontent.com/${{ github.repository }}/main/$img"

            if [ "$first" = false ]; then echo "," >> wallpapers.json; fi
            first=false

            cat <<EOF >> wallpapers.json
  {
    "title": "$TITLE",
    "url_img": "$RAW"
  }
EOF
          done
          echo "]" >> wallpapers.json

      - name: Commit JSON update
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add wallpapers.json
          git commit -m "Auto update wallpapers.json" || exit 0
          git push
